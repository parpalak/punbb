<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/**
 * Uses some JS and CSS techniques instead of captcha to prevent spam bots registrations.
 *
 * @copyright (C) 2011 by Roman Parpalak
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package rp_antispam
 */
-->

	<extension engine="1.0">
	<id>rp_antispam</id>
	<title>Smart Antispam</title>
	<version>0.1</version>
	<description>Uses some JS and CSS techniques instead of captcha to prevent spam bots registrations.</description>
	<author>Roman Parpalak</author>
	<minversion>1.3.4</minversion>
	<maxtestedon>1.3.4</maxtestedon>

	<note type="install">Add ".rp_antispam_name {display: none;}" to your forum CSS.</note>

	<hooks>
		<hook id="rg_start"><![CDATA[
// Load the captcha language file
if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
	require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
else
	require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
		]]></hook>

		<hook id="rg_register_form_submitted"><![CDATA[
if (session_id() == "")
	session_start();

if ((empty($_SESSION['js_antispam_code']) || strcmp(utf8_strtolower(trim($_POST['js_antispam_code'])), utf8_strtolower($_SESSION['js_antispam_code'])) !== 0))
	$errors[] = $lang_rp_antispam['Invalid Answer'];

if (trim($_POST['rp_antispam_name']))
	$errors[] = $lang_rp_antispam['Invalid Text'];
		]]></hook>

		<hook id="rg_register_pre_language"><![CDATA[
$a = rand(1, 8);
$b = rand(0, 9);
$c = rand(1, 9);

$bbb = rand(0, 1);
$add1 = rand (0, 100000);
$add2 = rand (0, 100);

$s = $a*10 + $b;

if (session_id() == "")
	session_start();

$_SESSION['js_antispam_code'] = $s + $c;

$s += $bbb ? $add1 : -$add1;

?>
				<div class="sf-set rp_antispam_name set<?php echo ++$forum_page['item_count'] ?>">
					<div class="sf-box text required">
						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_rp_antispam['Name'] ?></span> <small><?php echo $lang_rp_antispam['Name Info'] ?></small></label><br />
						<span class="fld-input"><input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="rp_antispam_name" value="<?php echo isset($_POST['js_antispam_code']) ? forum_htmlencode($_POST['rp_antispam_name']) : ''; ?>" size="20" maxlength="10" /></span>
					</div>
				</div>
				<div id="rp_antispam_q" class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
					<div class="sf-box text required">
						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php printf($lang_rp_antispam['Question'], '&#x003'.$a.';'.$b.';&#x002b;&#x003'.$c.';'); ?></span> <small><?php echo $lang_rp_antispam['Question Info'] ?></small></label><br />
						<span class="fld-input"><input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="js_antispam_code" value="<?php echo isset($_POST['js_antispam_code']) ? forum_htmlencode($_POST['js_antispam_code']) : ''; ?>" size="20" maxlength="10" /></span>
					</div>
				</div>
<?php
$rp_antispam_id = $forum_page['fld_count'];
		]]></hook>

		<hook id="rg_end"><![CDATA[
?>
	<script type="text/javascript">
var a=<?php echo ($s - $add2); ?>;
a=a<?php echo ($bbb ? '-' : '+'), $add1; ?>;
document.getElementById('fld<?php echo $rp_antispam_id; ?>').value=parseInt(a)+<?php echo ($c + $add2)?>;
document.getElementById("rp_antispam_q").style.display="none";
	</script>
<?php
		]]></hook>

	</hooks>

</extension>
